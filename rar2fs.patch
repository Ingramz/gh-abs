From a969ce5a0c120b31d82bdb63dcbddb3a037ff3d2 Mon Sep 17 00:00:00 2001
From: Hans Beckerus <hans.beckerus at gmail.com>
Date: Tue, 27 Oct 2020 12:36:45 +0100
Subject: [PATCH 1/3] Fix compilation problem for UnRAR source v6.0.1

This should fix issue reported in #144

Signed-off-by: Hans Beckerus <hans.beckerus at gmail.com>
---
 src/dllext.cpp | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

diff --git a/src/dllext.cpp b/src/dllext.cpp
index 92b25d4..e9d0582 100644
--- a/src/dllext.cpp
+++ b/src/dllext.cpp
@@ -377,7 +377,7 @@ static size_t ListFileHeader(wchar *wcs,Archive &Arc)
   if (hd.UnpSize==INT64NDF)
     wcscpy(UnpSizeText,L"?");
   else
-#if RARVER_MAJOR > 4 && RARVER_MINOR >= 30
+#if ( RARVER_MAJOR > 4 && RARVER_MINOR >= 30 ) || RARVER_MAJOR > 5
     itoa(hd.UnpSize,UnpSizeText,ASIZE(UnpSizeText));
   itoa(hd.PackSize,PackSizeText,ASIZE(PackSizeText));
 #else
@@ -402,7 +402,7 @@ static size_t ListFileHeader(wchar *wcs,Archive &Arc)
         swprintf(RatioStr,ASIZE(RatioStr),L"%d%%",ToPercentUnlim(hd.PackSize,hd.UnpSize));
 
   wchar DateStr[50];
-#if RARVER_MAJOR > 4 && RARVER_MINOR >= 30
+#if ( RARVER_MAJOR > 4 && RARVER_MINOR >= 30 ) || RARVER_MAJOR > 5
   hd.mtime.GetText(DateStr,ASIZE(DateStr),true);
 #else
   hd.mtime.GetText(DateStr,ASIZE(DateStr),true,true);
@@ -464,7 +464,7 @@ static size_t ListFileHeader(wchar *wcs,Archive &Arc)
     wcs += msprintf(wcs, L"\n%12ls: %ls",St(MListMtime),DateStr);
   if (hd.ctime.IsSet())
   {
-#if RARVER_MAJOR > 4 && RARVER_MINOR >= 30
+#if ( RARVER_MAJOR > 4 && RARVER_MINOR >= 30 ) || RARVER_MAJOR > 5
     hd.ctime.GetText(DateStr,ASIZE(DateStr),true);
 #else
     hd.ctime.GetText(DateStr,ASIZE(DateStr),true,true);
@@ -473,7 +473,7 @@ static size_t ListFileHeader(wchar *wcs,Archive &Arc)
   }
   if (hd.atime.IsSet())
   {
-#if RARVER_MAJOR > 4 && RARVER_MINOR >= 30
+#if ( RARVER_MAJOR > 4 && RARVER_MINOR >= 30 ) || RARVER_MAJOR > 5
     hd.atime.GetText(DateStr,ASIZE(DateStr),true);
 #else
     hd.atime.GetText(DateStr,ASIZE(DateStr),true,true);

From 53928fa566c17ac283bc8ce0e128c14469b31b7a Mon Sep 17 00:00:00 2001
From: Hans Beckerus <hans.beckerus at gmail.com>
Date: Sat, 7 Nov 2020 15:46:13 +0100
Subject: [PATCH 2/3] Fix a problem with corrupt/invalid size field

commit 130a36403f9bbbc26149f636e8f20695346253e1 introduced a workaround
for archives with corrupt/invalid uncompressed size information.
The workaround was however only applied if host OS was set to Unix.
Make sure the workaround is applied irrespective of host OS.

Resolves issue: #142

Signed-off-by: Hans Beckerus <hans.beckerus at gmail.com>
---
 src/rar2fs.c | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/src/rar2fs.c b/src/rar2fs.c
index 1378e41..736de43 100644
--- a/src/rar2fs.c
+++ b/src/rar2fs.c
@@ -2116,8 +2116,7 @@ static void set_rarstats(struct filecache_entry *entry_p, RARArchiveDataEx *arc,
                 st_size = GET_RAR_SZ(&arc->hdr);
                 /* Handle the one case discovered so far with archives having
                  * bad size information in the header. */
-                if ((st_size == INT64NDF) && entry_p->flags.raw &&
-                                arc->hdr.HostOS == HOST_UNIX)
+                if ((st_size == INT64NDF) && entry_p->flags.raw)
                         st_size = extract_file_size(entry_p->rar_p,
                                                     entry_p->file_p);
                 mode_t mode = GET_RAR_MODE(&arc->hdr);

From 80100e5f30e3069c91b674cff3ef6f70bb763559 Mon Sep 17 00:00:00 2001
From: Hans Beckerus <hans.beckerus at gmail.com>
Date: Sat, 7 Nov 2020 23:09:30 +0100
Subject: [PATCH 3/3] Handle archives without parent node in file header

Handle the case when the parent folders do not have their own entry in
the file header or is located at the end. The proper support for this
was impacted with the introduction of the directory cache.

Resolves issue: #147

Signed-off-by: Hans Beckerus <hans.beckerus at gmail.com>
---
 rarconfig.example |  2 +-
 src/rar2fs.c      | 20 ++++++++++++++++++++
 2 files changed, 21 insertions(+), 1 deletion(-)

diff --git a/rarconfig.example b/rarconfig.example
index fce448c..32f6f89 100644
--- a/rarconfig.example
+++ b/rarconfig.example
@@ -41,7 +41,7 @@
 
 # Example archive #1 (no password, alias)
 #[example1.rar]
-#	# Set seek lengt to 10
+#	# Set seek length to 10
 #	seek-length = 10
 #	alias = "/original_name","/alias_name"
 #
diff --git a/src/rar2fs.c b/src/rar2fs.c
index 736de43..25264a7 100644
--- a/src/rar2fs.c
+++ b/src/rar2fs.c
@@ -2654,6 +2654,7 @@ static int listrar(const char *path, struct dir_entry_list **buffer,
                  * later in the header the faked entry will be
                  * invalidated and replaced with the real file stats. */
                 if (is_root_path) {
+                        int populate_cache = 0;
                         char *safe_path = strdup(arc->hdr.FileName);
                         char *tmp = safe_path;
                         while (1) {
@@ -2671,10 +2672,29 @@ static int listrar(const char *path, struct dir_entry_list **buffer,
                                         __listrar_tocache_forcedir(entry_p, arc,
                                                         safe_path, *first_arch, &d);
                                         __listrar_cachedir(mp2);
+                                        populate_cache = 1;
                                 }
                                 free(mp2);
                         }
                         free(tmp);
+                        if (populate_cache) {
+                                /* Entries have been forced into the cache.
+                                 * Add the child node to each entry. */
+                                safe_path = strdup(arc->hdr.FileName);
+                                tmp = safe_path;
+                                while (1) {
+                                        char *mp2;
+
+                                        safe_path = __gnu_dirname(safe_path);
+                                        if (!CHRCMP(safe_path, '.'))
+                                                break;
+
+                                        ABS_MP2(mp2, path, safe_path);
+                                        __listrar_cachedirentry(mp2);
+                                        free(mp2);
+                               }
+                               free(tmp);
+                       }
                 }
 
                 /* Aliasing is not support for directories */
